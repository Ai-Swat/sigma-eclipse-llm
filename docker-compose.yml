services:
  build-windows:
    build:
      context: .
      dockerfile: Dockerfile.windows
    container_name: sigma-eclipse-windows-builder
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - node-modules:/app/node_modules
      # target directory is mapped to host filesystem (not a volume)
      # so build artifacts appear in your local src-tauri/target/
    environment:
      - CARGO_TARGET_DIR=/app/src-tauri/target
      - RUSTFLAGS=-C target-feature=+crt-static
    working_dir: /app
    command: bash -c "
      echo 'ðŸ”§ Creating placeholder for externalBin...' &&
      mkdir -p src-tauri/binaries &&
      touch src-tauri/binaries/sigma-eclipse-host-x86_64-pc-windows-gnu.exe &&
      echo 'ðŸ”§ Building native messaging host for Windows...' &&
      cd src-tauri &&
      cargo build --release --target x86_64-pc-windows-gnu --bin sigma-eclipse-host &&
      cp target/x86_64-pc-windows-gnu/release/sigma-eclipse-host.exe binaries/sigma-eclipse-host-x86_64-pc-windows-gnu.exe &&
      echo 'âœ“ Native host built and copied to binaries/' &&
      cd .. &&
      echo 'ðŸ”§ Building Tauri app for Windows...' &&
      npm run tauri build -- --target x86_64-pc-windows-gnu
      "

  # Helper service for interactive shell
  shell:
    build:
      context: .
      dockerfile: Dockerfile.windows
    container_name: sigma-eclipse-shell
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - node-modules:/app/node_modules
      # target directory is mapped to host filesystem
    working_dir: /app
    stdin_open: true
    tty: true
    entrypoint: /bin/bash

volumes:
  cargo-cache:
  cargo-git:
  node-modules:

